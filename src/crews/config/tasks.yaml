generate_explanation:
  description: >
    Create a mathematical explanation that simulates a teacher explaining concepts while writing on a whiteboard.
    For the query: {user_query}

    Think of this as a teaching script where each step pairs:
    - Natural speech (what the teacher says while writing)
    - MathML math (what's visible on the board at that moment)

    Output Format:
    {{
      "problem": "Original problem or concept being explained",
      "steps": [
        {{
          "natural": "What the teacher says during this step",
          "math": "The complete MathML notation visible during this step"
        }}
      ]
    }}

    Important: Each step shows the complete board state. Previous content is not preserved between steps, so each math field must contain everything that should be visible at that moment.

    Output Requirements:

    1. Mathematical Correctness:
       - Verify all mathematical expressions and calculations are correct
       - Check that equations maintain equality through transformations
       - Confirm all algebraic manipulations follow valid rules
       - Ensure numerical calculations are accurate
       - Validate mathematical properties and theorems are applied correctly
       - Double-check signs in operations (especially with negatives)
       - Verify proper order of operations is maintained
       - Confirm all mathematical definitions are used accurately

    2. Natural Language (TTS) Requirements:
       - Use complete, well-formed sentences
       - Include appropriate pauses using punctuation (periods, commas)
       - Avoid abbreviations, symbols, or mathematical notation in the natural text
       - Use verbal bridges like "now," "next," "then" to indicate progression
       - Spell out numbers when speaking (e.g., "negative two" instead of "-2")
       - Use clear transition words to indicate what you're doing
       - Include verbal cues about what's being written or highlighted
       - When referring to equations, describe them verbally
       - Use prosody-friendly language that flows naturally when spoken

    3. Mathematical Display Techniques:
       - Text and Layout Requirements:
         * PREFER vertical layout - put text and math on separate lines when possible
         * Only use inline text when absolutely necessary (e.g., short labels)
         * ALWAYS wrap text content in <mtext> tags
         * Include explicit spaces between words inside <mtext> tags
         * ALWAYS add <mspace width="0.3em"/> after inline <mtext> tags
         * Never place text directly in MathML without <mtext> tags
         * Use proper spacing around operators with <mo> tags
         * Example of vertical layout (preferred):
           <math>
             <mtable columnalign="left">
               <mtr>
                 <mtd>
                   <mrow>
                     <mtext>Consider the following equation:</mtext>
                   </mrow>
                 </mtd>
               </mtr>
               <mtr>
                 <mtd>
                   <mrow>
                     <mi>x</mi>
                     <mo>+</mo>
                     <mn>2</mn>
                     <mo>=</mo>
                     <mn>5</mn>
                   </mrow>
                 </mtd>
               </mtr>
             </mtable>
           </math>
         * Example of inline text (use sparingly):
           <math>
             <mtable columnalign="left">
               <mtr>
                 <mtd>
                   <mrow>
                     <mtext>When </mtext>
                     <mspace width="0.3em"/>
                     <mi>x</mi>
                     <mo>=</mo>
                     <mn>3</mn>
                     <mtext>, the equation is satisfied.</mtext>
                     <mspace width="0.3em"/>
                   </mrow>
                 </mtd>
               </mtr>
             </mtable>
           </math>

       - Multi-line Content Structure:
         * Use <mtable> for multi-line content
         * Each line goes in <mtr><mtd><mrow>...</mrow></mtd></mtr>
         * Set columnalign="left" for left-aligned equations
         * Example:
           <math>
             <mtable columnalign="left">
               <mtr>
                 <mtd>
                   <mrow>
                     <mtext>Let's solve this equation:</mtext>
                   </mrow>
                 </mtd>
               </mtr>
               <mtr>
                 <mtd>
                   <mrow>
                     <mn>2</mn><mi>x</mi><mo>+</mo><mn>3</mn><mi>y</mi><mo>=</mo><mn>8</mn>
                   </mrow>
                 </mtd>
               </mtr>
               <mtr>
                 <mtd>
                   <mrow>
                     <mn>4</mn><mi>x</mi><mo>-</mo><mn>5</mn><mi>y</mi><mo>=</mo><mn>2</mn>
                   </mrow>
                 </mtd>
               </mtr>
             </mtable>
           </math>
       
       - Visual Emphasis:
         * Color Usage (optimized for white background):
           - Current focus: mathcolor="#0066CC" (medium blue)
           - Important terms: mathcolor="#CC3300" (dark orange-red)
           - Completed steps: mathcolor="#006633" (forest green)
           - Related items: mathcolor="#663399" (royal purple)
         * Emphasis Techniques:
           - Use <menclose notation="circle"> to draw attention to terms
           - Use <menclose notation="box"> for key results/conclusions
           - Use <munder> for labels and annotations
           - Combine techniques: e.g., colored circles for maximum emphasis
         * Match Visual Emphasis to Narration:
           - Highlight terms as they're being discussed
           - Circle groups of terms being compared
           - Box final results or key conclusions
           - Use consistent colors throughout explanation
         * Example:
           <math>
             <mtable columnalign="left">
               <mtr>
                 <mtd>
                   <mrow>
                     <mtext>Let's identify the important terms:</mtext>
                   </mrow>
                 </mtd>
               </mtr>
               <mtr>
                 <mtd>
                   <mrow>
                     <menclose notation="circle" mathcolor="#0066CC">
                       <msup><mi>x</mi><mn>2</mn></msup>
                     </menclose>
                     <mo>+</mo>
                     <mn>5</mn>
                     <mi>x</mi>
                     <mo>+</mo>
                     <mn>6</mn>
                   </mrow>
                 </mtd>
               </mtr>
               <mtr>
                 <mtd>
                   <mrow>
                     <mtext>These terms are similar:</mtext>
                   </mrow>
                 </mtd>
               </mtr>
               <mtr>
                 <mtd>
                   <mrow>
                     <menclose notation="circle" mathcolor="#663399">
                       <mrow>
                         <mn>5</mn>
                         <mi>x</mi>
                       </mrow>
                     </menclose>
                     <mo>+</mo>
                     <mn>6</mn>
                     <mo>+</mo>
                     <menclose notation="circle" mathcolor="#663399">
                       <mrow>
                         <mn>2</mn>
                         <mi>x</mi>
                       </mrow>
                     </menclose>
                   </mrow>
                 </mtd>
               </mtr>
               <mtr>
                 <mtd>
                   <mrow>
                     <mtext>Our final result:</mtext>
                   </mrow>
                 </mtd>
               </mtr>
               <mtr>
                 <mtd>
                   <mrow>
                     <menclose notation="box" mathcolor="#006633">
                       <mrow>
                         <mn>7</mn>
                         <mi>x</mi>
                         <mo>+</mo>
                         <mn>6</mn>
                       </mrow>
                     </menclose>
                   </mrow>
                 </mtd>
               </mtr>
             </mtable>
           </math>
       
       - Layout Structure:
         * Use <mtable> for organizing content vertically
         * Put explanatory text on separate lines from math
         * Original problem/expression at the top
         * Working steps shown below in separate rows
         * Important results or conclusions emphasized
         * Clear visual hierarchy in multi-line displays
         * Example:
           <math>
             <mtable columnalign="left">
               <mtr>
                 <mtd>
                   <mrow>
                     <mtext>Let's add these fractions:</mtext>
                   </mrow>
                 </mtd>
               </mtr>
               <mtr>
                 <mtd>
                   <mrow>
                     <mfrac>
                       <mn>1</mn>
                       <mn>2</mn>
                     </mfrac>
                     <mo>+</mo>
                     <mfrac>
                       <mn>1</mn>
                       <mn>3</mn>
                     </mfrac>
                   </mrow>
                 </mtd>
               </mtr>
               <mtr>
                 <mtd>
                   <mrow>
                     <mtext>First, we need a common denominator:</mtext>
                   </mrow>
                 </mtd>
               </mtr>
               <mtr>
                 <mtd>
                   <mrow>
                     <mn mathcolor="#0066CC">6</mn>
                   </mrow>
                 </mtd>
               </mtr>
             </mtable>
           </math>

    4. Step Structure:
       - First step:
         * Clear introduction of the concept
         * Include "step by step" in the introduction
         * Present the initial problem clearly
         * Put introductory text on its own line
       
       - Subsequent steps should:
         * Show complete board state (including previous work when relevant)
         * Build progressively on previous steps
         * Use visual emphasis to guide attention
         * Connect verbal explanation to highlighted elements
         * Break down complex operations into smaller parts
         * Use table structure for multi-line progression
         * Verify mathematical correctness at each step
         * Put explanatory text on separate lines from mathematical expressions

    5. Format Requirements:
       natural: 
         - ONLY natural language optimized for TTS
         - NO mathematical symbols or notation
         - NO special characters except standard punctuation
       math: 
         - MUST use <mtable> for multi-line content
         - MUST wrap each line in <mtr><mtd><mrow>...</mrow></mtd></mtr>
         - MUST use columnalign="left" for aligned equations
         - MUST wrap ALL text content in <mtext> tags with proper spacing
         - MUST add <mspace width="0.3em"/> after inline <mtext> tags
         - PREFER putting text on separate lines from math
         - Valid MathML with correct syntax and proper spacing
         - Use mathcolor attribute for colored text
         - Include all previous relevant work
         - Ensure all mathematical expressions are correct

    6. Teaching Flow:
       - Each step should feel like a natural teaching moment
       - Visual emphasis should match verbal explanation
       - Clear progression in both speech and visuals
       - Appropriate pacing with verbal cues for transitions
       - Break down complex concepts into digestible pieces
       - Use color and emphasis to guide understanding
       - Verify mathematical accuracy throughout explanation
       - Maintain clear visual separation between text and math

    Example Multi-step Solution:
    {{
      "problem": "Solve the quadratic equation x² + 5x + 6 = 0",
      "steps": [
        {{
          "natural": "Let's solve this quadratic equation step by step.",
          "math": "<math>
            <mtable columnalign=\"left\">
              <mtr>
                <mtd>
                  <mrow>
                    <mtext>Let's solve this quadratic equation:</mtext>
                  </mrow>
                </mtd>
              </mtr>
              <mtr>
                <mtd>
                  <mrow>
                    <msup><mi>x</mi><mn>2</mn></msup>
                    <mo>+</mo>
                    <mn>5</mn>
                    <mi>x</mi>
                    <mo>+</mo>
                    <mn>6</mn>
                    <mo>=</mo>
                    <mn>0</mn>
                  </mrow>
                </mtd>
              </mtr>
            <mtr>
          <mtd>
            <mrow>
              <mtext>Let's identify each term:</mtext>
            </mrow>
          </mtd>
        </mtr>
        <mtr>
          <mtd>
            <mrow>
              <msup><mi mathcolor="#0066CC">x</mi><mn>2</mn></msup>
              <mtext> is our squared term</mtext>
              <mspace width="0.3em"/>
            </mrow>
          </mtd>
        </mtr>
        <mtr>
          <mtd>
            <mrow>
              <mn mathcolor="#0066CC">5</mn>
              <mi mathcolor="#0066CC">x</mi>
              <mtext> is our linear term</mtext>
              <mspace width="0.3em"/>
            </mrow>
          </mtd>
        </mtr>
        <mtr>
          <mtd>
            <mrow>
              <mn mathcolor="#0066CC">6</mn>
              <mtext> is our constant term</mtext>
              <mspace width="0.3em"/>
            </mrow>
          </mtd>
        </mtr>
        <mtr>
          <mtd>
            <mrow>
              <mtext>Now we can factor this into:</mtext>
            </mrow>
          </mtd>
        </mtr>
        <mtr>
          <mtd>
            <mrow>
              <menclose notation="box" mathcolor="#006633">
                <mrow>
                  <mo>(</mo>
                  <mi>x</mi>
                  <mo>+</mo>
                  <mn>2</mn>
                  <mo>)</mo>
                  <mo>(</mo>
                  <mi>x</mi>
                  <mo>+</mo>
                  <mn>3</mn>
                  <mo>)</mo>
                  <mo>=</mo>
                  <mn>0</mn>
                </mrow>
              </menclose>
            </mrow>
          </mtd>
        </mtr>
            </mtable>
          </math>"
        }}
      ]
    }}

  agent: math_teacher
  expected_output: "JSON with paired speech and MathML steps"

optimize_visual_narrative:
  description: >
    Transform a mathematical explanation into an engaging visual narrative by enhancing
    the MathML output with progressive build-up and visual emphasis that synchronizes
    with the spoken explanation.
    Input will be the output from generate_explanation. Your task is to:
    1. Break down steps into optimal visual frames
    2. Add visual emphasis and highlighting
    3. Create smooth visual transitions
    4. Synchronize visuals with spoken explanation
    5. Verify mathematical correctness of all expressions

    Output Structure:
    {{
      "problem": "Original problem or concept being explained",
      "steps": [
        {{
          "natural": "What the teacher says",
          "math": "Complete MathML board state with visual enhancements"
        }}
      ]
    }}

    Visual Enhancement Examples:

    Progressive Build-up Example - Introducing Quadratic Formula:

    Step 1:
    natural: Let's start with a quadratic equation in standard form.
    math: <math>
      <mtable columnalign="left">
        <mtr>
          <mtd>
            <mrow>
              <mtext>The standard form is:</mtext>
            </mrow>
          </mtd>
        </mtr>
        <mtr>
          <mtd>
            <mrow>
              <mi>a</mi><msup><mi>x</mi><mn>2</mn></msup>
              <mo>+</mo>
              <mi>b</mi><mi>x</mi>
              <mo>+</mo>
              <mi>c</mi>
              <mo>=</mo>
              <mn>0</mn>
            </mrow>
          </mtd>
        </mtr>
      </mtable>
    </math>

    Step 2:
    natural: First, look at the coefficient of x squared, which we call a.
    math: <math>
      <mtable columnalign="left">
        <mtr>
          <mtd>
            <mrow>
              <mtext>Looking at the first term:</mtext>
            </mrow>
          </mtd>
        </mtr>
        <mtr>
          <mtd>
            <mrow>
              <mi mathcolor="#0066CC">a</mi><msup><mi>x</mi><mn>2</mn></msup>
              <mo>+</mo>
              <mi>b</mi><mi>x</mi>
              <mo>+</mo>
              <mi>c</mi>
              <mo>=</mo>
              <mn>0</mn>
            </mrow>
          </mtd>
        </mtr>
      </mtable>
    </math>

    Step 3:
    natural: These three terms form our quadratic expression.
    math: <math>
      <mtable columnalign="left">
        <mtr>
          <mtd>
            <mrow>
              <mtext>Let's identify each term:</mtext>
            </mrow>
          </mtd>
        </mtr>
        <mtr>
          <mtd>
            <mrow>
              <mi>a</mi><msup><mi>x</mi><mn>2</mn></msup>
              <mo>+</mo>
              <mi>b</mi><mi>x</mi>
              <mo>+</mo>
              <mi>c</mi>
              <mo>=</mo>
              <mn>0</mn>
            </mrow>
          </mtd>
        </mtr>
        <mtr>
          <mtd>
            <mrow>
              <munder>
                <mrow><mi mathcolor="#0066CC">a</mi><msup><mi>x</mi><mn>2</mn></msup></mrow>
                <mtext>first term</mtext>
              </munder>
              <mo>+</mo>
              <munder>
                <mrow><mi>b</mi><mi>x</mi></mrow>
                <mtext>second term</mtext>
              </munder>
              <mo>+</mo>
              <munder>
                <mi>c</mi>
                <mtext>third term</mtext>
              </munder>
            </mrow>
          </mtd>
        </mtr>
      </mtable>
    </math>

    Requirements:

    1. Mathematical Verification:
      - Review all expressions for mathematical accuracy
      - Verify correctness of all calculations and transformations
      - Ensure mathematical properties are applied properly
      - Confirm logical progression of mathematical steps
      - Check consistency of mathematical notation
      - Validate all algebraic manipulations

    2. Visual Progression:
      - Break down complex steps into clear visual frames
      - Build concepts piece by piece
      - Maintain context while adding new elements
      - Show clear visual evolution
      - Use appropriate pacing
      - Put text and math on separate lines when possible

    3. Enhancement Techniques:
      - Colors (optimized for white background):
        * Current focus: mathcolor="#0066CC" (medium blue)
        * Important terms: mathcolor="#CC3300" (dark orange-red)
        * Completed steps: mathcolor="#006633" (forest green)
        * Related items: mathcolor="#663399" (royal purple)
      - Emphasis techniques:
        * <menclose notation="circle"> for highlighting terms
        * <menclose notation="box"> for key results
        * <munder> for labels
        * Combine color with emphasis for maximum effect
      - Boxes (<menclose notation="box">)
      - Underscores (<munder>)
      - Annotations (<mtext> with <mspace width="0.3em"/> after inline text)
      - Arrows (→, ↓)
      - Alignment using <mtable> and <mtr> for related equations
      - Checkmarks (✓) for completed steps

    4. Frame Guidelines:
      - Each frame must contain complete board state
      - Clear visual hierarchy
      - Consistent use of visual elements
      - Smooth transitions between frames
      - Visual elements should support spoken text
      - Proper spacing between elements
      - Verify mathematical correctness in each frame
      - ALWAYS wrap text content in <mtext> tags with proper spacing
      - ALWAYS add <mspace width="0.3em"/> after inline <mtext> tags
      - PREFER putting text on separate lines from math

    5. Visual Design Principles:
      - Focus attention on current concept
      - Build complexity gradually
      - Keep related elements visually connected
      - Use consistent visual language
      - Maintain clear layout with adequate spacing
      - Ensure proper text formatting with <mtext> tags
      - Prefer vertical layout with text and math on separate lines
  agent: math_teacher
  expected_output: "JSON with enhanced visual narrative"
  context:
    - generate_explanation
    
validate_mathml:
  description: >
    Validate and improve the MathML expressions in the mathematical explanation.
    Your task is to:
    1. Check each MathML expression for validity using the MathML Validator tool
    2. Fix any validation errors found
    3. Ensure all expressions follow MathML best practices
    4. Verify mathematical correctness is maintained
    5. Return the validated and improved explanation

    Input will be the output from optimize_visual_narrative.

    Output Format:
    {{
      "problem": "Original problem or concept being explained",
      "steps": [
        {{
          "natural": "What the teacher says",
          "math": "Validated and improved MathML"
        }}
      ]
    }}
    
  agent: math_reviewer
  expected_output: "JSON with validated MathML steps"
  context:
    - optimize_visual_narrative
